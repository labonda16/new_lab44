{% extends "base_template.html" %}

{% block title %}Add New Service{% endblock %}

{% block content %}
<h1 class="text-center mb-4">Add New Service</h1>

<form method="post" enctype="multipart/form-data">
    <div class="card mx-auto" style="max-width: 800px;">
        <div class="card-body">

            <!-- Nom du service -->
            <div class="mb-3">
                <label class="form-label">Service Name</label>
                <input type="text" class="form-control" name="name" placeholder="myservice" required>
            </div>

           <!-- Image Docker -->
            <div class="mb-3">
                <label class="form-label">Docker Image</label>
                <select class="form-select" name="image" id="imageSelect" required>
                    <option value="" disabled selected>Loading available images...</option>
                </select>
            </div>

            <!-- Ports -->
            <div class="mb-3">
                <label class="form-label">Internal Port</label>
                <input type="number" class="form-control" name="port_internal" placeholder="eg: 8080" required>
            </div>
            <div class="mb-3">
                <label class="form-label">Base External Port</label>
                <input type="number" class="form-control" name="port_base" placeholder="eg: 9000" required>
            </div>

            <!-- Volumes -->
            <div id="volumes-section">
                <label class="form-label">Volumes</label>
                <div class="input-group mb-2 volume-entry">
                    <input type="text" name="host_side_volume" class="form-control" placeholder="/host/path" required>
                    <input type="text" name="container_side_volume" class="form-control" placeholder="/container/path" required>
                    <button type="button" class="btn btn-danger" onclick="removeVolume(this)">Remove</button>
                </div>
            </div>
            <button type="button" class="btn btn-secondary w-100 mb-3" onclick="addVolume()">+ Add Volume</button>

            <!-- Variables d'environnement -->
            <label class="form-label mt-3">Environment Variables</label>
            <div id="env-section"></div>
            <button type="button" class="btn btn-secondary w-100 mb-3" onclick="addEnv()">+ Add Environment Variable</button>

            <!-- Ports supplémentaires -->
            <label class="form-label mt-3">Extra Ports to Expose</label>
            <div id="ports-section"></div>
            <button type="button" class="btn btn-secondary w-100 mb-4" onclick="addPort()">+ Add Port</button>

            <button type="submit" class="btn btn-primary w-100">Create Service</button>
        </div>
    </div>
</form>

<div class="text-center mt-4">
    <a href="/dashboard" class="btn btn-outline-secondary">Back to Dashboard</a>
</div>

<script>
function addVolume() {
    const container = document.getElementById("volumes-section");
    const div = document.createElement("div");
    div.className = "input-group mb-2 volume-entry";
    div.innerHTML = `
        <input type="text" name="volumes" class="form-control" placeholder="/host/path:/container/path" required>
        <input type="file" class="form-control" onchange="onFileSelect(this)" webkitdirectory directory multiple>
        <button type="button" class="btn btn-danger" onclick="removeVolume(this)">Remove</button>
    `;
    container.appendChild(div);
}

function removeVolume(btn) {
    btn.closest(".volume-entry").remove();
}

function addEnv() {
    const container = document.getElementById("env-section");
    const div = document.createElement("div");
    div.className = "input-group mb-2";
    div.innerHTML = `
        <input type="text" class="form-control" name="env_key" placeholder="KEY">
        <input type="text" class="form-control" name="env_value" placeholder="VALUE">
        <button type="button" class="btn btn-danger" onclick="removeEnv(this)">Remove</button>
    `;
    container.appendChild(div);
}

function removeEnv(btn) {
    btn.closest(".input-group").remove();
}

function addPort() {
    const container = document.getElementById("ports-section");
    const div = document.createElement("div");
    div.className = "input-group mb-2";
    div.innerHTML = `
        <input type="number" class="form-control" name="extra_ports" placeholder="Port number">
        <button type="button" class="btn btn-danger" onclick="removePort(this)">Remove</button>
    `;
    container.appendChild(div);
}

function removePort(btn) {
    btn.closest(".input-group").remove();
}

function onFileSelect(input) {
    // Optionnel : afficher dossier sélectionné
}

window.addEventListener('DOMContentLoaded', () => {
    fetch('/api/docker/images')
        .then(response => response.json())
        .then(images => {
            const select = document.getElementById("imageSelect");
            select.innerHTML = ''; // vider d'abord
            images.forEach(image => {
                const option = document.createElement("option");
                option.value = image;
                option.textContent = image;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error("Error loading Docker images:", error);
            const select = document.getElementById("imageSelect");
            select.innerHTML = '<option disabled>Error loading images</option>';
        });
});


</script>
{% endblock %}
